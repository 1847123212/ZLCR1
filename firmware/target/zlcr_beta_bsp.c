/**
 * @file    BSP.c
 * @author  yitiandelan
 * @date    2017-02-25
 * @brief   
 *
 * Copyright (c) 2016-2017, yitiandlan, All Rights Reserved
 * SPDX-License-Identifier: Apache-2.0
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include "BSP.h"
//#include "math.h"

int16_t I2S_ADCBuf[2048];
int16_t I2S_DACBuf[2048];
float fifo[4][1024];

float freq = 1000.0;     //f = fs / 2^22 * freqREG
uint32_t Wave_tick1 = 0; //freqREG
uint32_t Wave_sum1 = 0;  //phaseREG

float ADCGAIN[4] = {0.0f, 0.0f, 1.0f, 1.0f};

extern I2C_HandleTypeDef hi2c1;
extern I2S_HandleTypeDef hi2s3;
extern void DSP_I2S_Callback(float *pt1, float *pt2, float *pt3, float *pt4, uint16_t offset);
extern void DSP_I2S_CpltCallback(void);

const int16_t twiddleCoefQ15[] = {
    0, 147, 295, 442, 589, 736, 883, 1031, 1178, 1325, 1472, 1619, 1766, 1912, 2059, 2206, 2352, 2499, 2645, 2792, 2938, 3084, 3230, 3376, 3522, 3667, 3813, 3958, 4103, 4248, 4393, 4538, 4682, 4827, 4971, 5115, 5258, 5402, 5545, 5689, 5832, 5974, 6117, 6259, 6401, 6543, 6684, 6826, 6967, 7108, 7248, 7388, 7528, 7668, 7807, 7947, 8085, 8224, 8362, 8500, 8637, 8775, 8912, 9048, 9184, 9320, 9456, 9591, 9726, 9860, 9994, 10128, 10261, 10394, 10527, 10659, 10791, 10922, 11053, 11183, 11314, 11443, 11572, 11701, 11830, 11957, 12085, 12212, 12338, 12465, 12590, 12715, 12840, 12964, 13088, 13211, 13334, 13456, 13578, 13699, 13819, 13940, 14059, 14178, 14297, 14415, 14532, 14649, 14766, 14881, 14997, 15111, 15225, 15339, 15452, 15564, 15676, 15787, 15898, 16008, 16117, 16226, 16334, 16442, 16549, 16655, 16761, 16866, 16971, 17074, 17178, 17280, 17382, 17483, 17584, 17684, 17783, 17881, 17979, 18076, 18173, 18269, 18364, 18458, 18552, 18645, 18738, 18829, 18920, 19011, 19100, 19189, 19277, 19364, 19451, 19537, 19622, 19706, 19790, 19873, 19955, 20037, 20117, 20197, 20276, 20355, 20433, 20509, 20585, 20661, 20735, 20809, 20882, 20954, 21026, 21096, 21166, 21235, 21303, 21371, 21437, 21503, 21568, 21632, 21696, 21758, 21820, 21881, 21941, 22000, 22059, 22116, 22173, 22229, 22284, 22338, 22392, 22444, 22496, 22547, 22597, 22646, 22695, 22742, 22789, 22834, 22879, 22923, 22967, 23009, 23050, 23091, 23131, 23169, 23207, 23245, 23281, 23316, 23351, 23384, 23417, 23449, 23480, 23510, 23539, 23567, 23595, 23621, 23647, 23671, 23695, 23718, 23740, 23761, 23782, 23801, 23820, 23837, 23854, 23870, 23884, 23898, 23912, 23924, 23935, 23945, 23955, 23963, 23971, 23978, 23984, 23989, 23993, 23996, 23998, 24000, 24000, 24000, 23998, 23996, 23993, 23989, 23984, 23978, 23971, 23963, 23955, 23945, 23935, 23924, 23912, 23898, 23884, 23870, 23854, 23837, 23820, 23801, 23782, 23761, 23740, 23718, 23695, 23671, 23647, 23621, 23595, 23567, 23539, 23510, 23480, 23449, 23417, 23384, 23351, 23316, 23281, 23245, 23207, 23169, 23131, 23091, 23050, 23009, 22967, 22923, 22879, 22834, 22789, 22742, 22695, 22646, 22597, 22547, 22496, 22444, 22392, 22338, 22284, 22229, 22173, 22116, 22059, 22000, 21941, 21881, 21820, 21758, 21696, 21632, 21568, 21503, 21437, 21371, 21303, 21235, 21166, 21096, 21026, 20954, 20882, 20809, 20735, 20661, 20585, 20509, 20433, 20355, 20276, 20197, 20117, 20037, 19955, 19873, 19790, 19706, 19622, 19537, 19451, 19364, 19277, 19189, 19100, 19011, 18920, 18829, 18738, 18645, 18552, 18458, 18364, 18269, 18173, 18076, 17979, 17881, 17783, 17684, 17584, 17483, 17382, 17280, 17178, 17074, 16971, 16866, 16761, 16655, 16549, 16442, 16334, 16226, 16117, 16008, 15898, 15787, 15676, 15564, 15452, 15339, 15225, 15111, 14997, 14881, 14766, 14649, 14532, 14415, 14297, 14178, 14059, 13940, 13819, 13699, 13578, 13456, 13334, 13211, 13088, 12964, 12840, 12715, 12590, 12465, 12338, 12212, 12085, 11957, 11830, 11701, 11572, 11443, 11314, 11183, 11053, 10922, 10791, 10659, 10527, 10394, 10261, 10128, 9994, 9860, 9726, 9591, 9456, 9320, 9184, 9048, 8912, 8775, 8637, 8500, 8362, 8224, 8085, 7947, 7807, 7668, 7528, 7388, 7248, 7108, 6967, 6826, 6684, 6543, 6401, 6259, 6117, 5974, 5832, 5689, 5545, 5402, 5258, 5115, 4971, 4827, 4682, 4538, 4393, 4248, 4103, 3958, 3813, 3667, 3522, 3376, 3230, 3084, 2938, 2792, 2645, 2499, 2352, 2206, 2059, 1912, 1766, 1619, 1472, 1325, 1178, 1031, 883, 736, 589, 442, 295, 147, 0, -147, -295, -442, -589, -736, -883, -1031, -1178, -1325, -1472, -1619, -1766, -1912, -2059, -2206, -2352, -2499, -2645, -2792, -2938, -3084, -3230, -3376, -3522, -3667, -3813, -3958, -4103, -4248, -4393, -4538, -4682, -4827, -4971, -5115, -5258, -5402, -5545, -5689, -5832, -5974, -6117, -6259, -6401, -6543, -6684, -6826, -6967, -7108, -7248, -7388, -7528, -7668, -7807, -7947, -8085, -8224, -8362, -8500, -8637, -8775, -8912, -9048, -9184, -9320, -9456, -9591, -9726, -9860, -9994, -10128, -10261, -10394, -10527, -10659, -10791, -10922, -11053, -11183, -11314, -11443, -11572, -11701, -11830, -11957, -12085, -12212, -12338, -12465, -12590, -12715, -12840, -12964, -13088, -13211, -13334, -13456, -13578, -13699, -13819, -13940, -14059, -14178, -14297, -14415, -14532, -14649, -14766, -14881, -14997, -15111, -15225, -15339, -15452, -15564, -15676, -15787, -15898, -16008, -16117, -16226, -16334, -16442, -16549, -16655, -16761, -16866, -16971, -17074, -17178, -17280, -17382, -17483, -17584, -17684, -17783, -17881, -17979, -18076, -18173, -18269, -18364, -18458, -18552, -18645, -18738, -18829, -18920, -19011, -19100, -19189, -19277, -19364, -19451, -19537, -19622, -19706, -19790, -19873, -19955, -20037, -20117, -20197, -20276, -20355, -20433, -20509, -20585, -20661, -20735, -20809, -20882, -20954, -21026, -21096, -21166, -21235, -21303, -21371, -21437, -21503, -21568, -21632, -21696, -21758, -21820, -21881, -21941, -22000, -22059, -22116, -22173, -22229, -22284, -22338, -22392, -22444, -22496, -22547, -22597, -22646, -22695, -22742, -22789, -22834, -22879, -22923, -22967, -23009, -23050, -23091, -23131, -23169, -23207, -23245, -23281, -23316, -23351, -23384, -23417, -23449, -23480, -23510, -23539, -23567, -23595, -23621, -23647, -23671, -23695, -23718, -23740, -23761, -23782, -23801, -23820, -23837, -23854, -23870, -23884, -23898, -23912, -23924, -23935, -23945, -23955, -23963, -23971, -23978, -23984, -23989, -23993, -23996, -23998, -24000, -24000, -24000, -23998, -23996, -23993, -23989, -23984, -23978, -23971, -23963, -23955, -23945, -23935, -23924, -23912, -23898, -23884, -23870, -23854, -23837, -23820, -23801, -23782, -23761, -23740, -23718, -23695, -23671, -23647, -23621, -23595, -23567, -23539, -23510, -23480, -23449, -23417, -23384, -23351, -23316, -23281, -23245, -23207, -23169, -23131, -23091, -23050, -23009, -22967, -22923, -22879, -22834, -22789, -22742, -22695, -22646, -22597, -22547, -22496, -22444, -22392, -22338, -22284, -22229, -22173, -22116, -22059, -22000, -21941, -21881, -21820, -21758, -21696, -21632, -21568, -21503, -21437, -21371, -21303, -21235, -21166, -21096, -21026, -20954, -20882, -20809, -20735, -20661, -20585, -20509, -20433, -20355, -20276, -20197, -20117, -20037, -19955, -19873, -19790, -19706, -19622, -19537, -19451, -19364, -19277, -19189, -19100, -19011, -18920, -18829, -18738, -18645, -18552, -18458, -18364, -18269, -18173, -18076, -17979, -17881, -17783, -17684, -17584, -17483, -17382, -17280, -17178, -17074, -16971, -16866, -16761, -16655, -16549, -16442, -16334, -16226, -16117, -16008, -15898, -15787, -15676, -15564, -15452, -15339, -15225, -15111, -14997, -14881, -14766, -14649, -14532, -14415, -14297, -14178, -14059, -13940, -13819, -13699, -13578, -13456, -13334, -13211, -13088, -12964, -12840, -12715, -12590, -12465, -12338, -12212, -12085, -11957, -11830, -11701, -11572, -11443, -11314, -11183, -11053, -10922, -10791, -10659, -10527, -10394, -10261, -10128, -9994, -9860, -9726, -9591, -9456, -9320, -9184, -9048, -8912, -8775, -8637, -8500, -8362, -8224, -8085, -7947, -7807, -7668, -7528, -7388, -7248, -7108, -6967, -6826, -6684, -6543, -6401, -6259, -6117, -5974, -5832, -5689, -5545, -5402, -5258, -5115, -4971, -4827, -4682, -4538, -4393, -4248, -4103, -3958, -3813, -3667, -3522, -3376, -3230, -3084, -2938, -2792, -2645, -2499, -2352, -2206, -2059, -1912, -1766, -1619, -1472, -1325, -1178, -1031, -883, -736, -589, -442, -295, -147};
const float twiddleCoeff32[] = {
    0.000000e+00, 6.759538e-13, 1.351882e-12, 2.027760e-12, 2.703561e-12, 3.379260e-12, 4.054832e-12, 4.730252e-12, 5.405493e-12, 6.080531e-12, 6.755340e-12, 7.429894e-12, 8.104169e-12, 8.778139e-12, 9.451778e-12, 1.012506e-11, 1.079796e-11, 1.147046e-11, 1.214252e-11, 1.281413e-11, 1.348525e-11, 1.415587e-11, 1.482595e-11, 1.549548e-11, 1.616442e-11, 1.683275e-11, 1.750045e-11, 1.816749e-11, 1.883385e-11, 1.949950e-11, 2.016441e-11, 2.082857e-11, 2.149194e-11, 2.215450e-11, 2.281622e-11, 2.347709e-11, 2.413708e-11, 2.479615e-11, 2.545429e-11, 2.611148e-11, 2.676768e-11, 2.742287e-11, 2.807703e-11, 2.873013e-11, 2.938215e-11, 3.003307e-11, 3.068285e-11, 3.133148e-11, 3.197893e-11, 3.262518e-11, 3.327019e-11, 3.391396e-11, 3.455645e-11, 3.519763e-11, 3.583749e-11, 3.647601e-11, 3.711315e-11, 3.774889e-11, 3.838321e-11, 3.901608e-11, 3.964749e-11, 4.027740e-11, 4.090580e-11, 4.153266e-11, 4.215795e-11, 4.278166e-11, 4.340375e-11, 4.402421e-11, 4.464302e-11, 4.526014e-11, 4.587556e-11, 4.648925e-11, 4.710119e-11, 4.771136e-11, 4.831973e-11, 4.892629e-11, 4.953100e-11, 5.013384e-11, 5.073480e-11, 5.133385e-11, 5.193097e-11, 5.252613e-11, 5.311931e-11, 5.371049e-11, 5.429965e-11, 5.488677e-11, 5.547182e-11, 5.605478e-11, 5.663563e-11, 5.721435e-11, 5.779092e-11, 5.836531e-11, 5.893750e-11, 5.950747e-11, 6.007520e-11, 6.064067e-11, 6.120386e-11, 6.176474e-11, 6.232330e-11, 6.287951e-11, 6.343335e-11, 6.398481e-11, 6.453386e-11, 6.508047e-11, 6.562464e-11, 6.616633e-11, 6.670554e-11, 6.724223e-11, 6.777639e-11, 6.830800e-11, 6.883704e-11, 6.936349e-11, 6.988732e-11, 7.040853e-11, 7.092708e-11, 7.144296e-11, 7.195616e-11, 7.246664e-11, 7.297440e-11, 7.347940e-11, 7.398164e-11, 7.448110e-11, 7.497775e-11, 7.547158e-11, 7.596257e-11, 7.645070e-11, 7.693595e-11, 7.741830e-11, 7.789774e-11, 7.837424e-11, 7.884780e-11, 7.931838e-11, 7.978598e-11, 8.025058e-11, 8.071215e-11, 8.117069e-11, 8.162617e-11, 8.207857e-11, 8.252789e-11, 8.297410e-11, 8.341718e-11, 8.385713e-11, 8.429391e-11, 8.472753e-11, 8.515795e-11, 8.558517e-11, 8.600916e-11, 8.642992e-11, 8.684742e-11, 8.726166e-11, 8.767260e-11, 8.808025e-11, 8.848458e-11, 8.888558e-11, 8.928324e-11, 8.967753e-11, 9.006844e-11, 9.045597e-11, 9.084008e-11, 9.122078e-11, 9.159805e-11, 9.197186e-11, 9.234222e-11, 9.270909e-11, 9.307248e-11, 9.343236e-11, 9.378872e-11, 9.414156e-11, 9.449084e-11, 9.483658e-11, 9.517874e-11, 9.551731e-11, 9.585229e-11, 9.618367e-11, 9.651142e-11, 9.683553e-11, 9.715601e-11, 9.747282e-11, 9.778596e-11, 9.809542e-11, 9.840119e-11, 9.870326e-11, 9.900161e-11, 9.929623e-11, 9.958711e-11, 9.987424e-11, 1.001576e-10, 1.004372e-10, 1.007130e-10, 1.009851e-10, 1.012533e-10, 1.015177e-10, 1.017783e-10, 1.020351e-10, 1.022880e-10, 1.025370e-10, 1.027823e-10, 1.030236e-10, 1.032610e-10, 1.034946e-10, 1.037243e-10, 1.039501e-10, 1.041719e-10, 1.043899e-10, 1.046039e-10, 1.048139e-10, 1.050200e-10, 1.052222e-10, 1.054204e-10, 1.056146e-10, 1.058049e-10, 1.059912e-10, 1.061735e-10, 1.063517e-10, 1.065260e-10, 1.066963e-10, 1.068626e-10, 1.070248e-10, 1.071830e-10, 1.073372e-10, 1.074873e-10, 1.076334e-10, 1.077754e-10, 1.079134e-10, 1.080473e-10, 1.081771e-10, 1.083029e-10, 1.084246e-10, 1.085422e-10, 1.086557e-10, 1.087651e-10, 1.088704e-10, 1.089717e-10, 1.090688e-10, 1.091618e-10, 1.092507e-10, 1.093356e-10, 1.094162e-10, 1.094928e-10, 1.095652e-10, 1.096336e-10, 1.096978e-10, 1.097578e-10, 1.098137e-10, 1.098655e-10, 1.099132e-10, 1.099567e-10, 1.099961e-10, 1.100313e-10, 1.100624e-10, 1.100894e-10, 1.101122e-10, 1.101309e-10, 1.101454e-10, 1.101557e-10, 1.101620e-10, 1.101640e-10, 1.101620e-10, 1.101557e-10, 1.101454e-10, 1.101309e-10, 1.101122e-10, 1.100894e-10, 1.100624e-10, 1.100313e-10, 1.099961e-10, 1.099567e-10, 1.099132e-10, 1.098655e-10, 1.098137e-10, 1.097578e-10, 1.096978e-10, 1.096336e-10, 1.095652e-10, 1.094928e-10, 1.094162e-10, 1.093356e-10, 1.092507e-10, 1.091618e-10, 1.090688e-10, 1.089717e-10, 1.088704e-10, 1.087651e-10, 1.086557e-10, 1.085422e-10, 1.084246e-10, 1.083029e-10, 1.081771e-10, 1.080473e-10, 1.079134e-10, 1.077754e-10, 1.076334e-10, 1.074873e-10, 1.073372e-10, 1.071830e-10, 1.070248e-10, 1.068626e-10, 1.066963e-10, 1.065260e-10, 1.063517e-10, 1.061735e-10, 1.059912e-10, 1.058049e-10, 1.056146e-10, 1.054204e-10, 1.052222e-10, 1.050200e-10, 1.048139e-10, 1.046039e-10, 1.043899e-10, 1.041719e-10, 1.039501e-10, 1.037243e-10, 1.034946e-10, 1.032610e-10, 1.030236e-10, 1.027823e-10, 1.025370e-10, 1.022880e-10, 1.020351e-10, 1.017783e-10, 1.015177e-10, 1.012533e-10, 1.009851e-10, 1.007130e-10, 1.004372e-10, 1.001576e-10, 9.987424e-11, 9.958711e-11, 9.929623e-11, 9.900161e-11, 9.870326e-11, 9.840119e-11, 9.809542e-11, 9.778596e-11, 9.747282e-11, 9.715601e-11, 9.683553e-11, 9.651142e-11, 9.618367e-11, 9.585229e-11, 9.551731e-11, 9.517874e-11, 9.483658e-11, 9.449084e-11, 9.414156e-11, 9.378872e-11, 9.343236e-11, 9.307248e-11, 9.270909e-11, 9.234222e-11, 9.197186e-11, 9.159805e-11, 9.122078e-11, 9.084008e-11, 9.045597e-11, 9.006844e-11, 8.967753e-11, 8.928324e-11, 8.888558e-11, 8.848458e-11, 8.808025e-11, 8.767260e-11, 8.726166e-11, 8.684742e-11, 8.642992e-11, 8.600916e-11, 8.558517e-11, 8.515795e-11, 8.472753e-11, 8.429391e-11, 8.385713e-11, 8.341718e-11, 8.297410e-11, 8.252789e-11, 8.207857e-11, 8.162617e-11, 8.117069e-11, 8.071215e-11, 8.025058e-11, 7.978598e-11, 7.931838e-11, 7.884780e-11, 7.837424e-11, 7.789774e-11, 7.741830e-11, 7.693595e-11, 7.645070e-11, 7.596257e-11, 7.547158e-11, 7.497775e-11, 7.448110e-11, 7.398164e-11, 7.347940e-11, 7.297440e-11, 7.246664e-11, 7.195616e-11, 7.144296e-11, 7.092708e-11, 7.040853e-11, 6.988732e-11, 6.936349e-11, 6.883704e-11, 6.830800e-11, 6.777639e-11, 6.724223e-11, 6.670554e-11, 6.616633e-11, 6.562464e-11, 6.508047e-11, 6.453386e-11, 6.398481e-11, 6.343335e-11, 6.287951e-11, 6.232330e-11, 6.176474e-11, 6.120386e-11, 6.064067e-11, 6.007520e-11, 5.950747e-11, 5.893750e-11, 5.836531e-11, 5.779092e-11, 5.721435e-11, 5.663563e-11, 5.605478e-11, 5.547182e-11, 5.488677e-11, 5.429965e-11, 5.371049e-11, 5.311931e-11, 5.252613e-11, 5.193097e-11, 5.133385e-11, 5.073480e-11, 5.013384e-11, 4.953100e-11, 4.892629e-11, 4.831973e-11, 4.771136e-11, 4.710119e-11, 4.648925e-11, 4.587556e-11, 4.526014e-11, 4.464302e-11, 4.402421e-11, 4.340375e-11, 4.278166e-11, 4.215795e-11, 4.153266e-11, 4.090580e-11, 4.027740e-11, 3.964749e-11, 3.901608e-11, 3.838321e-11, 3.774889e-11, 3.711315e-11, 3.647601e-11, 3.583749e-11, 3.519763e-11, 3.455645e-11, 3.391396e-11, 3.327019e-11, 3.262518e-11, 3.197893e-11, 3.133148e-11, 3.068285e-11, 3.003307e-11, 2.938215e-11, 2.873013e-11, 2.807703e-11, 2.742287e-11, 2.676768e-11, 2.611148e-11, 2.545429e-11, 2.479615e-11, 2.413708e-11, 2.347709e-11, 2.281622e-11, 2.215450e-11, 2.149194e-11, 2.082857e-11, 2.016441e-11, 1.949950e-11, 1.883385e-11, 1.816749e-11, 1.750045e-11, 1.683275e-11, 1.616442e-11, 1.549548e-11, 1.482595e-11, 1.415587e-11, 1.348525e-11, 1.281413e-11, 1.214252e-11, 1.147046e-11, 1.079796e-11, 1.012506e-11, 9.451778e-12, 8.778139e-12, 8.104169e-12, 7.429894e-12, 6.755340e-12, 6.080531e-12, 5.405493e-12, 4.730252e-12, 4.054832e-12, 3.379260e-12, 2.703561e-12, 2.027760e-12, 1.351882e-12, 6.759538e-13, -3.543146e-26, -6.759538e-13, -1.351882e-12, -2.027760e-12, -2.703561e-12, -3.379260e-12, -4.054832e-12, -4.730252e-12, -5.405493e-12, -6.080531e-12, -6.755340e-12, -7.429894e-12, -8.104169e-12, -8.778139e-12, -9.451778e-12, -1.012506e-11, -1.079796e-11, -1.147046e-11, -1.214252e-11, -1.281413e-11, -1.348525e-11, -1.415587e-11, -1.482595e-11, -1.549548e-11, -1.616442e-11, -1.683275e-11, -1.750045e-11, -1.816749e-11, -1.883385e-11, -1.949950e-11, -2.016441e-11, -2.082857e-11, -2.149194e-11, -2.215450e-11, -2.281622e-11, -2.347709e-11, -2.413708e-11, -2.479615e-11, -2.545429e-11, -2.611148e-11, -2.676768e-11, -2.742287e-11, -2.807703e-11, -2.873013e-11, -2.938215e-11, -3.003307e-11, -3.068285e-11, -3.133148e-11, -3.197893e-11, -3.262518e-11, -3.327019e-11, -3.391396e-11, -3.455645e-11, -3.519763e-11, -3.583749e-11, -3.647601e-11, -3.711315e-11, -3.774889e-11, -3.838321e-11, -3.901608e-11, -3.964749e-11, -4.027740e-11, -4.090580e-11, -4.153266e-11, -4.215795e-11, -4.278166e-11, -4.340375e-11, -4.402421e-11, -4.464302e-11, -4.526014e-11, -4.587556e-11, -4.648925e-11, -4.710119e-11, -4.771136e-11, -4.831973e-11, -4.892629e-11, -4.953100e-11, -5.013384e-11, -5.073480e-11, -5.133385e-11, -5.193097e-11, -5.252613e-11, -5.311931e-11, -5.371049e-11, -5.429965e-11, -5.488677e-11, -5.547182e-11, -5.605478e-11, -5.663563e-11, -5.721435e-11, -5.779092e-11, -5.836531e-11, -5.893750e-11, -5.950747e-11, -6.007520e-11, -6.064067e-11, -6.120386e-11, -6.176474e-11, -6.232330e-11, -6.287951e-11, -6.343335e-11, -6.398481e-11, -6.453386e-11, -6.508047e-11, -6.562464e-11, -6.616633e-11, -6.670554e-11, -6.724223e-11, -6.777639e-11, -6.830800e-11, -6.883704e-11, -6.936349e-11, -6.988732e-11, -7.040853e-11, -7.092708e-11, -7.144296e-11, -7.195616e-11, -7.246664e-11, -7.297440e-11, -7.347940e-11, -7.398164e-11, -7.448110e-11, -7.497775e-11, -7.547158e-11, -7.596257e-11, -7.645070e-11, -7.693595e-11, -7.741830e-11, -7.789774e-11, -7.837424e-11, -7.884780e-11, -7.931838e-11, -7.978598e-11, -8.025058e-11, -8.071215e-11, -8.117069e-11, -8.162617e-11, -8.207857e-11, -8.252789e-11, -8.297410e-11, -8.341718e-11, -8.385713e-11, -8.429391e-11, -8.472753e-11, -8.515795e-11, -8.558517e-11, -8.600916e-11, -8.642992e-11, -8.684742e-11, -8.726166e-11, -8.767260e-11, -8.808025e-11, -8.848458e-11, -8.888558e-11, -8.928324e-11, -8.967753e-11, -9.006844e-11, -9.045597e-11, -9.084008e-11, -9.122078e-11, -9.159805e-11, -9.197186e-11, -9.234222e-11, -9.270909e-11, -9.307248e-11, -9.343236e-11, -9.378872e-11, -9.414156e-11, -9.449084e-11, -9.483658e-11, -9.517874e-11, -9.551731e-11, -9.585229e-11, -9.618367e-11, -9.651142e-11, -9.683553e-11, -9.715601e-11, -9.747282e-11, -9.778596e-11, -9.809542e-11, -9.840119e-11, -9.870326e-11, -9.900161e-11, -9.929623e-11, -9.958711e-11, -9.987424e-11, -1.001576e-10, -1.004372e-10, -1.007130e-10, -1.009851e-10, -1.012533e-10, -1.015177e-10, -1.017783e-10, -1.020351e-10, -1.022880e-10, -1.025370e-10, -1.027823e-10, -1.030236e-10, -1.032610e-10, -1.034946e-10, -1.037243e-10, -1.039501e-10, -1.041719e-10, -1.043899e-10, -1.046039e-10, -1.048139e-10, -1.050200e-10, -1.052222e-10, -1.054204e-10, -1.056146e-10, -1.058049e-10, -1.059912e-10, -1.061735e-10, -1.063517e-10, -1.065260e-10, -1.066963e-10, -1.068626e-10, -1.070248e-10, -1.071830e-10, -1.073372e-10, -1.074873e-10, -1.076334e-10, -1.077754e-10, -1.079134e-10, -1.080473e-10, -1.081771e-10, -1.083029e-10, -1.084246e-10, -1.085422e-10, -1.086557e-10, -1.087651e-10, -1.088704e-10, -1.089717e-10, -1.090688e-10, -1.091618e-10, -1.092507e-10, -1.093356e-10, -1.094162e-10, -1.094928e-10, -1.095652e-10, -1.096336e-10, -1.096978e-10, -1.097578e-10, -1.098137e-10, -1.098655e-10, -1.099132e-10, -1.099567e-10, -1.099961e-10, -1.100313e-10, -1.100624e-10, -1.100894e-10, -1.101122e-10, -1.101309e-10, -1.101454e-10, -1.101557e-10, -1.101620e-10, -1.101640e-10, -1.101620e-10, -1.101557e-10, -1.101454e-10, -1.101309e-10, -1.101122e-10, -1.100894e-10, -1.100624e-10, -1.100313e-10, -1.099961e-10, -1.099567e-10, -1.099132e-10, -1.098655e-10, -1.098137e-10, -1.097578e-10, -1.096978e-10, -1.096336e-10, -1.095652e-10, -1.094928e-10, -1.094162e-10, -1.093356e-10, -1.092507e-10, -1.091618e-10, -1.090688e-10, -1.089717e-10, -1.088704e-10, -1.087651e-10, -1.086557e-10, -1.085422e-10, -1.084246e-10, -1.083029e-10, -1.081771e-10, -1.080473e-10, -1.079134e-10, -1.077754e-10, -1.076334e-10, -1.074873e-10, -1.073372e-10, -1.071830e-10, -1.070248e-10, -1.068626e-10, -1.066963e-10, -1.065260e-10, -1.063517e-10, -1.061735e-10, -1.059912e-10, -1.058049e-10, -1.056146e-10, -1.054204e-10, -1.052222e-10, -1.050200e-10, -1.048139e-10, -1.046039e-10, -1.043899e-10, -1.041719e-10, -1.039501e-10, -1.037243e-10, -1.034946e-10, -1.032610e-10, -1.030236e-10, -1.027823e-10, -1.025370e-10, -1.022880e-10, -1.020351e-10, -1.017783e-10, -1.015177e-10, -1.012533e-10, -1.009851e-10, -1.007130e-10, -1.004372e-10, -1.001576e-10, -9.987424e-11, -9.958711e-11, -9.929623e-11, -9.900161e-11, -9.870326e-11, -9.840119e-11, -9.809542e-11, -9.778596e-11, -9.747282e-11, -9.715601e-11, -9.683553e-11, -9.651142e-11, -9.618367e-11, -9.585229e-11, -9.551731e-11, -9.517874e-11, -9.483658e-11, -9.449084e-11, -9.414156e-11, -9.378872e-11, -9.343236e-11, -9.307248e-11, -9.270909e-11, -9.234222e-11, -9.197186e-11, -9.159805e-11, -9.122078e-11, -9.084008e-11, -9.045597e-11, -9.006844e-11, -8.967753e-11, -8.928324e-11, -8.888558e-11, -8.848458e-11, -8.808025e-11, -8.767260e-11, -8.726166e-11, -8.684742e-11, -8.642992e-11, -8.600916e-11, -8.558517e-11, -8.515795e-11, -8.472753e-11, -8.429391e-11, -8.385713e-11, -8.341718e-11, -8.297410e-11, -8.252789e-11, -8.207857e-11, -8.162617e-11, -8.117069e-11, -8.071215e-11, -8.025058e-11, -7.978598e-11, -7.931838e-11, -7.884780e-11, -7.837424e-11, -7.789774e-11, -7.741830e-11, -7.693595e-11, -7.645070e-11, -7.596257e-11, -7.547158e-11, -7.497775e-11, -7.448110e-11, -7.398164e-11, -7.347940e-11, -7.297440e-11, -7.246664e-11, -7.195616e-11, -7.144296e-11, -7.092708e-11, -7.040853e-11, -6.988732e-11, -6.936349e-11, -6.883704e-11, -6.830800e-11, -6.777639e-11, -6.724223e-11, -6.670554e-11, -6.616633e-11, -6.562464e-11, -6.508047e-11, -6.453386e-11, -6.398481e-11, -6.343335e-11, -6.287951e-11, -6.232330e-11, -6.176474e-11, -6.120386e-11, -6.064067e-11, -6.007520e-11, -5.950747e-11, -5.893750e-11, -5.836531e-11, -5.779092e-11, -5.721435e-11, -5.663563e-11, -5.605478e-11, -5.547182e-11, -5.488677e-11, -5.429965e-11, -5.371049e-11, -5.311931e-11, -5.252613e-11, -5.193097e-11, -5.133385e-11, -5.073480e-11, -5.013384e-11, -4.953100e-11, -4.892629e-11, -4.831973e-11, -4.771136e-11, -4.710119e-11, -4.648925e-11, -4.587556e-11, -4.526014e-11, -4.464302e-11, -4.402421e-11, -4.340375e-11, -4.278166e-11, -4.215795e-11, -4.153266e-11, -4.090580e-11, -4.027740e-11, -3.964749e-11, -3.901608e-11, -3.838321e-11, -3.774889e-11, -3.711315e-11, -3.647601e-11, -3.583749e-11, -3.519763e-11, -3.455645e-11, -3.391396e-11, -3.327019e-11, -3.262518e-11, -3.197893e-11, -3.133148e-11, -3.068285e-11, -3.003307e-11, -2.938215e-11, -2.873013e-11, -2.807703e-11, -2.742287e-11, -2.676768e-11, -2.611148e-11, -2.545429e-11, -2.479615e-11, -2.413708e-11, -2.347709e-11, -2.281622e-11, -2.215450e-11, -2.149194e-11, -2.082857e-11, -2.016441e-11, -1.949950e-11, -1.883385e-11, -1.816749e-11, -1.750045e-11, -1.683275e-11, -1.616442e-11, -1.549548e-11, -1.482595e-11, -1.415587e-11, -1.348525e-11, -1.281413e-11, -1.214252e-11, -1.147046e-11, -1.079796e-11, -1.012506e-11, -9.451778e-12, -8.778139e-12, -8.104169e-12, -7.429894e-12, -6.755340e-12, -6.080531e-12, -5.405493e-12, -4.730252e-12, -4.054832e-12, -3.379260e-12, -2.703561e-12, -2.027760e-12, -1.351882e-12, -6.759538e-13};

const uint8_t CodecInit[][2] =
    {
        /* DAC Step */
        {0x00, 0x00}, //Select Page 0
        {0x0b, 0x81}, //NDAC = 1,Power up
        {0x0c, 0x82}, //MDAC = 2,Power up
        {0x0d, 0x00}, //DOSR = 128
        {0x0e, 0x80}, //DOSR LSB
        {0x3c, 0x01}, //PRB_P1

        /* ADC Step */
        {0x12, 0x81}, //NADC = 1,Power up
        {0x13, 0x82}, //MADC = 2,Power up
        {0x14, 0x80}, //AOSR = 128
        {0x3d, 0x01}, //PRB_R1

        /* Audio Interface */
        {0x1b, 0x00}, //16bit
        {0x55, 0x00}, //ADC Phase Adjust Register

        /* Power Step */
        {0x00, 0x01}, //Select Page 1
        {0x01, 0x08}, //Disabled weak connection of AVDD with DVDD
        {0x02, 0x01}, //Analog Block Power up,AVDD LDO Power up
        //{0x0a,0x3b},  //Input Vcom = 0.9v,Output Vcom = 1.65v
        {0x0a, 0x03},

        {0x03, 0x00}, //DAC PTM mode to PTM_P3/4
        {0x04, 0x00},
        {0x3d, 0x00}, //ADC PTM mode to PTM_R4

        //  {0x7b,0x01},  //REF settime to 40ms
        //  {0x14,0x25},  //HP settime  to

        /* Input Step */
        {0x34, 0x10}, //Route IN2L to LEFT_P with 10k
        {0x36, 0x10}, //Route IN2R to LEFT_M with 10k
        {0x37, 0x40}, //Route IN1R to RIGHT_P with 10k
        {0x39, 0x10}, //Route IN1L to RIGHT_M with 10k

        {0x3b, 0x00}, //Left  MicPGA not mute,gain to 0dB
        {0x3c, 0x00}, //Right MicPGA not mute,gain to 0dB

        /* Output Step */
        {0x0c, 0x08}, //Route Left  DAC to HPL
        {0x0d, 0x08}, //Route Right DAC to HPR
        {0x0e, 0x08}, //Route Left  DAC to LOL
        {0x0f, 0x08}, //Route Right DAC to LOR

        {0x10, 0x00}, //HPL gain  to 0dB
        {0x11, 0x00}, //HPR gain  to 0dB
        {0x12, 0x08}, //LOL gain  to 0dB
        {0x13, 0x08}, //LOR gain  to 0dB

        {0x16, 0x75}, //IN1L to HPL, MUTE
        {0x17, 0x75}, //IN1R to HPL, MUTE

        {0x09, 0x3c}, //LOL,LOR,HPL,HPR,Power up

        /* Initial ok */
        {0x00, 0x00}, //Select Page 0
        {0x3f, 0xd6}, //L&R DAC Power up
        {0x40, 0x00}, //L&R DAC not mute
        {0x51, 0xc0}, //L&R ADC Power up
        {0x52, 0x00}, //L&R ADC not mute, ADC Fine Gain Adjust
        {0x53, 0x00}, //Left  ADC Digital gain
        {0x54, 0x00}, //Right ADC Digital gain
};

void BSP_Setfreq(float f)
{
  if (f > 90000.0f)
    f = 90000.0f;
  if (f < 0.0f)
    f = 0.0f;
  Wave_tick1 = 22906.5f * f;
  freq = Wave_tick1 / 22906.5f;
}

void BSP_SetGAIN(float GAIN1, float GAIN2)
{
  int n1 = GAIN1 * 2.0f + 0.5f;
  int n2 = GAIN2 * 2.0f + 0.5f;

  if (n1 < 0)
    n1 = 0;
  if (n1 > 95)
    n1 = 95;
  if (n2 < 0)
    n2 = 0;
  if (n2 > 95)
    n2 = 95;

  ADCGAIN[0] = n1 / 2.0f;
  ADCGAIN[1] = n2 / 2.0f;
  //  ADCGAIN[2] = pow(10, ADCGAIN[0] / 20.0f);
  //  ADCGAIN[3] = pow(10, ADCGAIN[1] / 20.0f);
  ADCGAIN[2] = 1.0f;
  ADCGAIN[3] = 1.0f;

  Single_WriteI2C(0x00, 0x01); //Select Page 1
  Single_WriteI2C(0x3b, n1);   //Left  MicPGA,
  Single_WriteI2C(0x3c, n2);   //Right MicPGA,
}

void HAL_I2S_TxHalfCpltCallback(I2S_HandleTypeDef *hi2s)
{
  uint16_t i, tmp;
  for (i = 1; i <= 1024; i += 2)
  {
    tmp = Wave_sum1 >> 22; //10bit
    Wave_sum1 += Wave_tick1;

    I2S_DACBuf[i] = twiddleCoefQ15[tmp];
    fifo[0][i >> 1] = I2S_ADCBuf[i - 1];
    fifo[1][i >> 1] = I2S_ADCBuf[i];
    fifo[2][i >> 1] = twiddleCoeff32[tmp];
    fifo[3][i >> 1] = twiddleCoeff32[(tmp + 768) & 0x3ff]; //2^10=1024
  }

  DSP_I2S_Callback(fifo[0], fifo[1], fifo[2], fifo[3], 0);
}

void HAL_I2S_TxCpltCallback(I2S_HandleTypeDef *hi2s)
{
  uint16_t i, tmp;
  for (i = 1024 + 1; i <= 2048; i += 2)
  {
    tmp = Wave_sum1 >> 22;
    Wave_sum1 += Wave_tick1;

    I2S_DACBuf[i] = twiddleCoefQ15[tmp];
    fifo[0][i >> 1] = I2S_ADCBuf[i - 1];
    fifo[1][i >> 1] = I2S_ADCBuf[i];
    fifo[2][i >> 1] = twiddleCoeff32[tmp];
    fifo[3][i >> 1] = twiddleCoeff32[(tmp + 768) & 0x3ff]; //2^10=1024
  }

  DSP_I2S_Callback(fifo[0], fifo[1], fifo[2], fifo[3], 512);
  DSP_I2S_CpltCallback();
}

void BSP_CODEC_Init(void)
{
  uint16_t size = sizeof(CodecInit) / sizeof(CodecInit[0][0]) / 2;
  uint16_t i;

  //  hi2s3.Instance->I2SPR = 0x0202;
  //  for(i=0;i<1024;i++)
  //    I2S_DACBuf[(i<<1)+1] = twiddleCoefQ15[i];

  /* TLV320AIC3204 reset */
  Single_WriteI2C(0x00, 0x00);
  Single_WriteI2C(0x01, 0x01);

  HAL_Delay(5);

  for (i = 0; i < size; i++)
    Single_WriteI2C(CodecInit[i][0], CodecInit[i][1]);

  BSP_Setfreq(freq);
  BSP_SetGAIN(ADCGAIN[0], ADCGAIN[1]);
}

void BSP_CODEC_Start(void)
{
  HAL_I2SEx_TransmitReceive_DMA(&hi2s3, (uint16_t *)&I2S_DACBuf, (uint16_t *)&I2S_ADCBuf, 2048);
}

void Single_WriteI2C(uint8_t REG_Address, uint8_t REG_data)
{
  uint8_t txData[2] = {REG_Address, REG_data};
  while (HAL_I2C_Master_Transmit(&hi2c1, I2C_ADDRESS, txData, 2, 100) != HAL_OK)
  {
    if (HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
    {
    }
  }
}
uint8_t Single_ReadI2C(uint8_t REG_Address)
{
  uint8_t REG_data;
  while (HAL_I2C_Master_Transmit(&hi2c1, I2C_ADDRESS, &REG_Address, 1, 100) != HAL_OK)
  {
    if (HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
    {
    }
  }

  if (HAL_I2C_Master_Receive(&hi2c1, I2C_ADDRESS + 1, &REG_data, 1, 100) != HAL_OK)
  {
    if (HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
    {
    }
  }
  return REG_data;
}
